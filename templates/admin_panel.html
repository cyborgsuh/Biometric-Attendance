{% extends "base.html" %}

{% block title %}Admin Panel - Biometric Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Admin Panel</li>
            </ol>
        </nav>
        
        <div class="row mb-4">
            <div class="col-md-3">
                <!-- Admin Navigation -->
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            Admin Menu
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="admin-tab-list" role="tablist">
                            <a class="list-group-item list-group-item-action active" id="student-management-tab" data-bs-toggle="list" href="#student-management" role="tab" aria-controls="student-management">
                                <i class="fas fa-users me-2"></i> Student Management
                            </a>
                            <a class="list-group-item list-group-item-action" id="attendance-report-tab" data-bs-toggle="list" href="#attendance-report" role="tab" aria-controls="attendance-report">
                                <i class="fas fa-chart-bar me-2"></i> Attendance Reports
                            </a>
                            <a class="list-group-item list-group-item-action" id="system-settings-tab" data-bs-toggle="list" href="#system-settings" role="tab" aria-controls="system-settings">
                                <i class="fas fa-sliders-h me-2"></i> System Settings
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>
                            Quick Stats
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 class="card-subtitle mb-1 text-muted">Total Students</h6>
                            <h3 id="totalStudents">...</h3>
                        </div>
                        <div class="mb-3">
                            <h6 class="card-subtitle mb-1 text-muted">Present Today</h6>
                            <h3 id="presentToday">...</h3>
                        </div>
                        <div>
                            <h6 class="card-subtitle mb-1 text-muted">Absent Today</h6>
                            <h3 id="absentToday">...</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-9">
                <!-- Tab Content -->
                <div class="tab-content" id="admin-tab-content">
                    <!-- Student Management Tab -->
                    <div class="tab-pane fade show active" id="student-management" role="tabpanel" aria-labelledby="student-management-tab">
                        <div class="card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2"></i>
                                    Student Management
                                </h5>
                                <a href="/add-student" class="btn btn-sm btn-light">
                                    <i class="fas fa-plus me-1"></i> Add New
                                </a>
                            </div>
                            <div class="card-body">
                                <!-- Search and Filter -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="studentSearch" placeholder="Search students...">
                                    </div>
                                </div>
                                
                                <!-- Student Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Registered On</th>
                                                <th>Face Data</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center">Loading students...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attendance Reports Tab -->
                    <div class="tab-pane fade" id="attendance-report" role="tabpanel" aria-labelledby="attendance-report-tab">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Attendance Reports
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Report Filters -->
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="reportDateFrom" class="form-label">From Date</label>
                                            <input type="date" class="form-control" id="reportDateFrom">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="reportDateTo" class="form-label">To Date</label>
                                            <input type="date" class="form-control" id="reportDateTo">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="reportStudent" class="form-label">Student</label>
                                            <select class="form-select" id="reportStudent">
                                                <option value="">All Students</option>
                                                <!-- Options will be added by JavaScript -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid mb-4">
                                    <button class="btn btn-primary" id="generateReport">
                                        <i class="fas fa-chart-line me-1"></i> Generate Report
                                    </button>
                                </div>
                                
                                <!-- Report Results -->
                                <div id="reportResults" class="d-none">
                                    <h5 class="mb-3">Report Results</h5>
                                    
                                    <!-- Summary Cards -->
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <div class="card bg-success text-white">
                                                <div class="card-body">
                                                    <h5 class="card-title">Present Days</h5>
                                                    <h2 id="presentCount">0</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-danger text-white">
                                                <div class="card-body">
                                                    <h5 class="card-title">Absent Days</h5>
                                                    <h2 id="absentCount">0</h2>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-warning text-white">
                                                <div class="card-body">
                                                    <h5 class="card-title">Late Days</h5>
                                                    <h2 id="lateCount">0</h2>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Report Table -->
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="reportTable">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Student</th>
                                                    <th>Status</th>
                                                    <th>Check-in</th>
                                                    <th>Check-out</th>
                                                    <th>Duration</th>
                                                </tr>
                                            </thead>
                                            <tbody id="reportTableBody">
                                                <!-- Will be filled by JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Export Buttons -->
                                    <div class="d-flex justify-content-end gap-2 mt-3">
                                        <button class="btn btn-outline-primary" id="exportReportCSV">
                                            <i class="fas fa-file-csv me-1"></i> Export CSV
                                        </button>
                                        <button class="btn btn-outline-primary" id="printReportBtn">
                                            <i class="fas fa-print me-1"></i> Print
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Settings Tab -->
                    <div class="tab-pane fade" id="system-settings" role="tabpanel" aria-labelledby="system-settings-tab">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-sliders-h me-2"></i>
                                    System Settings
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="settingsForm">
                                    <div class="mb-3">
                                        <label for="faceRecognitionThreshold" class="form-label">Face Recognition Threshold</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" id="faceRecognitionThreshold" min="0.4" max="0.9" step="0.05" value="0.6">
                                            <span class="ms-2" id="thresholdValue">0.6</span>
                                        </div>
                                        <div class="form-text">Lower values are more strict, higher values are more lenient.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Attendance Time Settings</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="input-group mb-2">
                                                    <span class="input-group-text">Start Time</span>
                                                    <input type="time" class="form-control" id="attendanceStartTime" value="09:00">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="input-group mb-2">
                                                    <span class="input-group-text">End Time</span>
                                                    <input type="time" class="form-control" id="attendanceEndTime" value="17:00">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Late Arrival Threshold</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="lateThreshold" min="1" max="60" value="15">
                                            <span class="input-group-text">minutes</span>
                                        </div>
                                        <div class="form-text">Students arriving after start time + this threshold will be marked as late.</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">System Email Notifications</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableEmailNotifications">
                                            <label class="form-check-label" for="enableEmailNotifications">Enable email notifications</label>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i> Save Settings
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Edit Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStudentModalLabel">Edit Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editStudentForm">
                    <input type="hidden" id="editStudentId">
                    <div class="mb-3">
                        <label for="editStudentIdField" class="form-label">Student ID</label>
                        <input type="text" class="form-control" id="editStudentIdField" required>
                    </div>
                    <div class="mb-3">
                        <label for="editStudentName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editStudentName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editStudentEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editStudentEmail" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveStudentBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this student?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load students
        loadStudents();
        updateQuickStats();
        
        // Threshold slider value display
        const thresholdSlider = document.getElementById('faceRecognitionThreshold');
        const thresholdValue = document.getElementById('thresholdValue');
        
        if (thresholdSlider && thresholdValue) {
            thresholdSlider.addEventListener('input', function() {
                thresholdValue.textContent = this.value;
            });
        }
        
        // Settings form submission
        const settingsForm = document.getElementById('settingsForm');
        if (settingsForm) {
            settingsForm.addEventListener('submit', function(e) {
                e.preventDefault();
                alert('Settings saved successfully!');
            });
        }
        
        // Generate report button
        const generateReportBtn = document.getElementById('generateReport');
        const reportResults = document.getElementById('reportResults');
        
        if (generateReportBtn && reportResults) {
            generateReportBtn.addEventListener('click', function() {
                // Show loading state
                generateReportBtn.disabled = true;
                generateReportBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';
                
                // Simulate report generation
                setTimeout(() => {
                    reportResults.classList.remove('d-none');
                    generateReportBtn.disabled = false;
                    generateReportBtn.innerHTML = '<i class="fas fa-chart-line me-1"></i> Generate Report';
                    
                    // Sample data for demonstration
                    document.getElementById('presentCount').textContent = '15';
                    document.getElementById('absentCount').textContent = '3';
                    document.getElementById('lateCount').textContent = '2';
                    
                    // Populate report table
                    const reportTableBody = document.getElementById('reportTableBody');
                    if (reportTableBody) {
                        reportTableBody.innerHTML = '';
                        
                        // Sample data
                        const sampleData = [
                            { date: '2023-05-01', student: 'John Doe', status: 'present', checkIn: '09:05:23', checkOut: '17:02:45', duration: '7h 57m' },
                            { date: '2023-05-01', student: 'Jane Smith', status: 'present', checkIn: '08:55:12', checkOut: '17:10:33', duration: '8h 15m' },
                            { date: '2023-05-02', student: 'John Doe', status: 'late', checkIn: '09:25:08', checkOut: '17:05:19', duration: '7h 40m' },
                            { date: '2023-05-02', student: 'Jane Smith', status: 'present', checkIn: '08:58:02', checkOut: '17:00:45', duration: '8h 02m' },
                            { date: '2023-05-03', student: 'John Doe', status: 'absent', checkIn: '-', checkOut: '-', duration: '-' }
                        ];
                        
                        sampleData.forEach(record => {
                            const row = document.createElement('tr');
                            
                            // Set row class based on status
                            if (record.status === 'absent') {
                                row.classList.add('table-danger');
                            } else if (record.status === 'late') {
                                row.classList.add('table-warning');
                            } else {
                                row.classList.add('table-success');
                            }
                            
                            row.innerHTML = `
                                <td>${record.date}</td>
                                <td>${record.student}</td>
                                <td>${record.status}</td>
                                <td>${record.checkIn}</td>
                                <td>${record.checkOut}</td>
                                <td>${record.duration}</td>
                            `;
                            
                            reportTableBody.appendChild(row);
                        });
                    }
                }, 1500);
            });
        }
        
        // Student search functionality
        const studentSearch = document.getElementById('studentSearch');
        if (studentSearch) {
            studentSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#studentTableBody tr:not(.no-results)');
                
                let hasResults = false;
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        row.style.display = '';
                        hasResults = true;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // Show/hide no results message
                const noResultsRow = document.querySelector('#studentTableBody tr.no-results');
                if (noResultsRow) {
                    if (hasResults) {
                        noResultsRow.style.display = 'none';
                    } else {
                        noResultsRow.style.display = '';
                    }
                }
            });
        }
        
        // Student edit modal
        const saveStudentBtn = document.getElementById('saveStudentBtn');
        if (saveStudentBtn) {
            saveStudentBtn.addEventListener('click', function() {
                const studentId = document.getElementById('editStudentId').value;
                const studentIdField = document.getElementById('editStudentIdField').value;
                const name = document.getElementById('editStudentName').value;
                const email = document.getElementById('editStudentEmail').value;
                
                // Validate form
                if (!studentIdField || !name || !email) {
                    alert('Please fill in all fields');
                    return;
                }
                
                // Show loading state
                saveStudentBtn.disabled = true;
                saveStudentBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
                
                // Send update request
                fetch(`/api/students/${studentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_id: studentIdField,
                        name: name,
                        email: email
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update student');
                    }
                    return response.json();
                })
                .then(() => {
                    // Close modal and reload students
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
                    modal.hide();
                    loadStudents();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating student: ' + error.message);
                })
                .finally(() => {
                    // Reset button state
                    saveStudentBtn.disabled = false;
                    saveStudentBtn.innerHTML = 'Save Changes';
                });
            });
        }
        
        // Delete student confirmation
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function() {
                const studentId = this.dataset.studentId;
                
                // Show loading state
                confirmDeleteBtn.disabled = true;
                confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...';
                
                // Send delete request
                fetch(`/api/students/${studentId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete student');
                    }
                    return response.json();
                })
                .then(() => {
                    // Close modal and reload students
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                    modal.hide();
                    loadStudents();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting student: ' + error.message);
                })
                .finally(() => {
                    // Reset button state
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.innerHTML = 'Delete';
                });
            });
        }
    });
    
    // Function to load students
    function loadStudents() {
        const studentTableBody = document.getElementById('studentTableBody');
        
        if (studentTableBody) {
            // Show loading state
            studentTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading students...</td></tr>';
            
            // Fetch students from API
            fetch('/api/students/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to load students');
                    }
                    return response.json();
                })
                .then(students => {
                    // Clear loading state
                    studentTableBody.innerHTML = '';
                    
                    if (students.length === 0) {
                        studentTableBody.innerHTML = '<tr class="no-results"><td colspan="6" class="text-center">No students found</td></tr>';
                        return;
                    }
                    
                    // Populate table
                    students.forEach(student => {
                        const row = document.createElement('tr');
                        
                        // Format date
                        const createdDate = new Date(student.created_at).toLocaleDateString();
                        
                        // Check if face data exists
                        const hasFaceData = student.face_encoding ? 'Yes' : 'No';
                        const faceDataClass = student.face_encoding ? 'text-success' : 'text-danger';
                        
                        row.innerHTML = `
                            <td>${student.student_id}</td>
                            <td>${student.name}</td>
                            <td>${student.email}</td>
                            <td>${createdDate}</td>
                            <td><span class="${faceDataClass}">${hasFaceData}</span></td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary edit-student" data-student-id="${student.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger delete-student" data-student-id="${student.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        studentTableBody.appendChild(row);
                    });
                    
                    // Add event listeners to edit buttons
                    document.querySelectorAll('.edit-student').forEach(button => {
                        button.addEventListener('click', function() {
                            const studentId = this.dataset.studentId;
                            
                            // Fetch student data
                            fetch(`/api/students/${studentId}`)
                                .then(response => response.json())
                                .then(student => {
                                    // Populate form
                                    document.getElementById('editStudentId').value = student.id;
                                    document.getElementById('editStudentIdField').value = student.student_id;
                                    document.getElementById('editStudentName').value = student.name;
                                    document.getElementById('editStudentEmail').value = student.email;
                                    
                                    // Show modal
                                    const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
                                    modal.show();
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    alert('Error loading student data: ' + error.message);
                                });
                        });
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-student').forEach(button => {
                        button.addEventListener('click', function() {
                            const studentId = this.dataset.studentId;
                            
                            // Set student ID in delete confirmation button
                            document.getElementById('confirmDeleteBtn').dataset.studentId = studentId;
                            
                            // Show modal
                            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
                            modal.show();
                        });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    studentTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${error.message}</td></tr>`;
                });
        }
    }
    
    // Function to update quick stats
    function updateQuickStats() {
        const totalStudents = document.getElementById('totalStudents');
        const presentToday = document.getElementById('presentToday');
        const absentToday = document.getElementById('absentToday');
        
        if (totalStudents && presentToday && absentToday) {
            // Get current date
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateString = `${year}-${month}-${day}`;
            
            // Fetch today's attendance report
            fetch(`/api/attendance/report/daily?date=${dateString}`)
                .then(response => response.json())
                .then(data => {
                    // Count present and absent students
                    const present = data.filter(record => record.status !== 'absent').length;
                    const absent = data.filter(record => record.status === 'absent').length;
                    
                    // Update stats
                    totalStudents.textContent = data.length;
                    presentToday.textContent = present;
                    absentToday.textContent = absent;
                })
                .catch(error => {
                    console.error('Error updating stats:', error);
                    totalStudents.textContent = 'Error';
                    presentToday.textContent = 'Error';
                    absentToday.textContent = 'Error';
                });
        }
    }
</script>
{% endblock %}
